
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>RUMD Loop Command Station</title>
    <link rel="stylesheet" href="../static/graph.css">

    <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
    <script type="text/javascript" src="../static/d3.js" charset="utf-8"></script>
    <script type="text/javascript" src="../static/d3-line-chart.js" charset="utf-8"></script>
    <script type="text/javascript" charset="utf-8">
        $(document).ready(function(){

            //modification of open-source code from here: https://github.com/miguelgrinberg/Flask-SocketIO



            var lineChart = new LineChart();
            var velocityChart = new LineChart();

            var dataPoints = [];

            token_val = sessionStorage.token;

            namespace = '/test'; // change to an empty string to use the global namespace
            // the socket.io documentation recommends sending an explicit package upon connection
            // this is specially important when using the global namespace

            var socketURL = 'http://' + document.domain + ':' + location.port + namespace

            console.log("socketURL = " + socketURL);

            var socket = io.connect(socketURL);

            var pod_id_val = ""




            socket.on('test_recv', function(msg) {
                $('#log').append('<br>' + $('<div/>').text('Received command: from client with id = ' + msg.client_id + ', data = ' + msg.data).html());
            });

            // event handler for new connections
            socket.on('connect', function() {
                console.log("Connected!");
                socket.emit('my event', {data: 'I\'m connected!'});
            });
            // handlers for the different forms in the page
            // these send data to the server in a variety of ways:

            //this will be used to send free form commands to the pod
            $('form#emit').submit(function(event) {
              if(pod_id_val === null || pod_id_val === undefined || pod_id_val.length < 1){
                alert('Pod ID is null!')
              }
              else{
                socket.emit('cmd_send', {data: $('#emit_data').val(),token : token_val,pod_id:pod_id_val, client_id:sessionStorage.client_id });
              }

              return false;
            });

            //this will be used to connect with a specific pod
            $('form#join').submit(function(event) {
                pod_id_val = $('#join_pod').val();

                $('#log').append('<br>' + $('<div/>').text('Listening to ' + pod_id_val).html());

                // when the client detects this response, it "html-ifies" the data and shows it on the page
                // this will be how telemetry is received and shown
                socket.on('data_receive_' + pod_id_val, function(msg) {

                    /*
                      types
                        1 = xyz position
                        2 = xyz velocity and magnitude
                        3 = xyz acceleration and magnitudde
                        4 = vehicle attitiude
                        5 = internal pressure
                        6 = external pressure
                        7 = internal temp
                        8 = external temp
                        9 = power consumption
                        10 = actuator state
                        11 = WARNING during
                        12 = WARNING after/prior
                      */






                    var type = msg.type;
                    var text = "Received data from pod with id: " + msg.pod_id;

                    var dataObj = JSON.parse(msg.data);


                    dataObj.type = type;
                    console.log("object with data = " + dataObj.x);

                    dataPoints.push({type: dataObj.type, x: dataObj.x, y: dataObj.y});




                    if(type == 1){


                        lineChart.remove();

                        text = text + " -> Position = x: " + dataObj.x + " y: " + dataObj.y + " z: " + dataObj.z + " at time: " + msg.timestamp;
                        console.log("text = " + text);

                        var valuesArray = [];

                        for(var i = 0; i < dataPoints.length; i++){
                          var obj = dataPoints[i];
                          console.log("object with data = " + obj.x);
                          if (Number(obj.type) == 1){
                            console.log("match");
                            valuesArray.push({x: Number(obj.x), y: Number(obj.y)});
                          }
                        }

                        var data = {
                            name: 'Position vs Time',
                            values: valuesArray
                        };


                        lineChart.x_axis_text = "Time";
                        lineChart.y_axis_text = "Position";
                        lineChart.for([data]).plot();

                    }
                    else if(type == 2){

                        text = text + " -> Velocity = x: " + dataObj.x + " y: " + dataObj.y + " z: " + dataObj.z + " magnitude: " + dataObj.magnitude + " at time: " + msg.timestamp;

                        velocityChart.remove();

                        var valuesArray = [];

                        for(var i = 0; i < dataPoints.length; i++){
                          var obj = dataPoints[i];
                          console.log("object with data = " + obj.x);
                          if (Number(obj.type) == 2){
                            console.log("match");
                            valuesArray.push({x: Number(obj.x), y: Number(obj.y)});
                          }
                        }

                        var data = {
                            name: 'Velocity vs Time',
                            values: valuesArray
                        };


                        velocityChart.x_axis_text = "Time";
                        velocityChart.y_axis_text = "Velocity";
                        velocityChart.for([data]).plot();

                    }
                    else if(type == 3){

                        text = text + " -> Acceleration = x: " + dataObj.x + " y: " + dataObj.y + " z: " + dataObj.z + " magnitude: " + dataObj.magnitude + " at time: " + msg.timestamp;

                    }
                    else if(type == 4){

                        text = text + " -> Attitude = roll: " + dataObj.roll + " pitch: " + dataObj.pitch + " yaw: " + dataObj.yaw +  " at time: " + msg.timestamp;

                    }
                    else if(type == 5){

                        text = text + " -> Internal Pressure for ";
                        var units = dataObj.units;

                        for(var i = 0; i < units.length; i++){

                          var unit = units[i];
                          text = text + unit.name + " = " + unit.value + ", ";

                        }

                        text = text + " at time: " + msg.timestamp;

                    }
                    else if(type == 6){

                      text = text + " -> External Pressure = front: " + dataObj.front + " rear: " + dataObj.rear + " at time: " + msg.timestamp;

                    }
                    else if(type == 7){

                      text = text + " -> Internal Temperature = ambient: " + dataObj.ambient + " battery: " + dataObj.battery + " computer: " + dataObj.computer + " at time: " + msg.timestamp;

                    }
                    else if(type == 8){

                      text = text + " -> External Temperature = front: " + dataObj.front + " rear: " + dataObj.rear + " bottom: " + dataObj.bottom + " at time: " + msg.timestamp;

                    }
                    else if(type == 9){

                      text = text + " -> Power Consumption = " + dataObj.consumption + " at time: " + msg.timestamp;

                    }
                    else if(type == 10){

                      text = text + " Actuator State = " + dataObj.state + " at time: " + msg.timestamp;

                    }

                    else if(type == 11){

                      text = text + "RUNTIME WARNING = " + dataObj.warning + " at time: " + msg.timestamp;

                    }

                    else if(type == 12){

                      text = text + dataObj.stage + " WARNING = " + dataObj.warning + " at time: " + msg.timestamp;

                    }
                    else{

                      text = 'Received data: from pod with id = ' + msg.pod_id + ', data = ' + msg.data;

                    }

                    $('#log').append('<br><br>' + $('<div/>').text(text).html() );
                });

                return false;
            });

            //this will be used for POD STOP command
            $('form#pod_stop').submit(function(event) {
                if(pod_id_val === null || pod_id_val === undefined || pod_id_val.length < 1){
                  alert('Pod ID is null!')
                }
                else{
                  socket.emit('cmd_send', {data : 'pod_stop_cmd', token : token_val, pod_id : pod_id_val, client_id : sessionStorage.client_id});
                }

                return false;
            });

            //this will be used to disconnect from the pod it is connected to
            $('form#disconnect').submit(function(event) {
                socket.emit('disconnect request');
                return false;
            });


            //used to simulate pod data
            $('form#pod').submit(function(event) {
              socket.emit('data_send',{'data' : $('#pod_data').val(), 'pod_id' : sessionStorage.pod_id, 'token' : sessionStorage.pod_token, 'type' : parseInt($('#data_type').val()), 'timestamp': (new Date()).toString()});
              return false;
            });


            $('form#pod_create').submit(function(event) {

              man_code_val = $('#man_code').val();




              $.post("http://localhost:5000/createPod",{

                man_code : man_code_val,


              }, function(data,status){

                  if(data['status'] === 'ok'){

                    sessionStorage.pod_id = data['pod_id'];

                    $('#log').append('<br>' + $('<div/>').text("Pod successfully created! Now authenticate! Pod ID is " + sessionStorage.pod_id).html());



                  }
                  else{

                    alert(data['reason']);

                  }



              });

              return false;
            });

            $('form#pod_auth').submit(function(event) {






              $.post("http://localhost:5000/auth",{

                is_pod : true,
                pod_id : sessionStorage.pod_id


              }, function(data,status){

                  if(data['status'] === 'ok'){

                    sessionStorage.pod_token = data['secret_token'];

                    $('#log').append('<br>' + $('<div/>').text("Authentication Successful!").html());


                  }
                  else{

                    alert(data['reason']);

                  }



              });

              return false;
            });



        });
    </script>
</head>
<body>



    <h1>RUMD Loop Command Station</h1>
    <h2>Send:</h2>

    <form id="emit" method="POST" action='#'>
        <input type="text" name="emit_data" id="emit_data" placeholder="Message">
        <input type="submit" value="Send Command">
    </form>
    <form id="join" method="POST" action='#'>
        <input type="text" name="join_pod" id="join_pod" placeholder="Pod ID">
        <input type="submit" value="Connect to Pod">
    </form>
    <form id="pod_stop" method="POST" action="#">
      <input type="submit" value="Pod Stop">
    </form>
    <form id="disconnect" method="POST" action="#">
        <input type="submit" value="Disconnect">
    </form>
    <h2>Pod Simulation</h2>
    <form id="pod_create" method="POST" action="#">
      <input type="text" name="man_code" id="man_code" placeholder="Manafacture Code">
      <input type="submit" value="Create Pod">
    </form>
    <form id="pod_auth" method="POST" action="#">
      <input type="submit" value="Authenticate Pod">
    </form>
    <form id="pod" method="POST" action="#">
      <input type="text" name="pod_data" id="pod_data" placeholder="Pod Data">
      <br>
      <input type="text" name="data_type" id="data_type" placeholder="Data Type ID (1-12)">
      <br>
      <input type="submit" value="Send Pod Data">
    </form>
    <h2>Telemetry</h2>
    <div id="log"></div>
    <div id="graphs"></div>



    </body>

</html>
